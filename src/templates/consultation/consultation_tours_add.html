{{ define "content" }}
<h2>Добавление туров к консультации</h2>

<form id="addToursForm" method="POST">
    <input type="hidden" name="consultation_id" value="{{ .ConsultationID }}">

    {{ if .Tours }}
        {{ range .Tours }}
            <div>
                <label>
                    <input type="checkbox" name="tours" value="{{ .ID }}"
                        {{ if .Checked }}checked{{ end }}>
                    {{ .Name }} — {{ .Country }}
                </label>
                <div style="margin-left: 20px;">
                    Скидка: <input type="text" name="discount_{{ .ID }}" value="{{ .Discount }}"><br>
                    Кол-во: <input type="text" name="quantity_{{ .ID }}" value="{{ .Quantity }}">
                </div>
            </div>
        {{ end }}
    {{ else }}
        <p>Нет доступных туров.</p>
    {{ end }}

    <br>
    <button type="submit">Сохранить туры</button>
</form>

<script>
document.getElementById("addToursForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const form = e.target;
    const selected = Array.from(form.querySelectorAll('input[name="tours"]:checked')).map(cb => cb.value);
    
    const formData = new URLSearchParams();
    selected.forEach(id => {
        formData.append("tours", id);
        formData.append("discount_" + id, form.querySelector(`input[name="discount_${id}"]`).value);
        formData.append("quantity_" + id, form.querySelector(`input[name="quantity_${id}"]`).value);
    });

    const res = await fetch(`/consultation/${form.consultation_id.value}/tours`, {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: formData.toString()
    });

    if (res.ok) {
        alert("Туры успешно добавлены");
        window.location.href = "/consultation";
    } else {
        const data = await res.json();
        alert(data.error || "Ошибка при добавлении туров");
    }
});
</script>
{{ end }}

{{ template "base.html" . }}
