{{ define "content" }}
<h2>Редактирование сотрудника</h2>

<form id="editEmployeeForm">
    <input type="hidden" name="id" value="{{ .Employee.ID }}">

    <label>Email:</label><br>
    <input type="email" id="email" name="email" value="{{ .Employee.Email }}" required><br><br>

    <label>Имя:</label><br>
    <input type="text" id="firstName" name="firstName" value="{{ .Employee.FirstName }}" required><br><br>

    <label>Фамилия:</label><br>
    <input type="text" id="lastName" name="lastName" value="{{ .Employee.LastName }}" required><br><br>

    <label>Отчество:</label><br>
    <input type="text" id="middleName" name="middleName" value="{{ .Employee.MiddleName }}"><br><br>

    <label>Адрес:</label><br>
    <input type="text" id="address" name="address" value="{{ .Employee.Address }}" required><br><br>

<label for="phoneNumber">Телефон:</label><br>
<input type="tel" id="phoneNumber" name="phoneNumber" pattern="[0-9]*" value="{{ .Employee.PhoneNumber }}"><br><br>

    <label>Дата рождения:</label><br>
    <input type="date" id="dateOfBirth" name="dateOfBirth" value="{{ if .Employee.DateOfBirth }}{{ .Employee.DateOfBirth.Format "2006-01-02" }}{{ end }}"><br><br>

    <label>Дата приёма на работу:</label><br>
    <input type="date" id="dateOfHiring" name="dateOfHiring" value="{{ if .Employee.DateOfHiring }}{{ .Employee.DateOfHiring.Format "2006-01-02" }}{{ end }}"><br><br>

    <label>Должность:</label><br>
    <select id="position" name="position" required>
        <option value="">-- Выберите должность --</option>
        {{ range .Positions }}
        <option value="{{ .ID }}" {{ if eq .ID $.Employee.PositionID }}selected{{ end }}>{{ .Name }}</option>
        {{ end }}
    </select><br><br>

    <button type="submit">Сохранить изменения</button>
</form>

<script>
document.getElementById("editEmployeeForm").addEventListener("submit", async function(e) {
    e.preventDefault();

        const formatToTimestamp = (dateStr) => {
    return dateStr ? `${dateStr}T00:00:00Z` : null;
        };
    const form = document.getElementById("editEmployeeForm");

    const data = {
        id: form.querySelector('input[name="id"]').value,
        email: form.querySelector('input[name="email"]').value,
        firstName: form.querySelector('input[name="firstName"]').value,
        lastName: form.querySelector('input[name="lastName"]').value,
        middleName: form.querySelector('input[name="middleName"]').value,
        address: form.querySelector('input[name="address"]').value,
        phoneNumber: form.querySelector('input[name="phoneNumber"]').value,
    dateOfBirth: formatToTimestamp(document.getElementById("dateOfBirth").value),
    dateOfHiring: formatToTimestamp(document.getElementById("dateOfHiring").value),
        position: form.querySelector('select[name="position"]').value
    };

    try {
        const res = await fetch(`/employee/edit/${data.id}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        });

        if (res.ok) {
            alert("Сотрудник обновлён");
            window.location.href = "/employee";
        } else {
            const result = await res.json();
            alert(result.error || "Ошибка при обновлении");
        }
    } catch (err) {
        alert("Ошибка: " + err.message);
    }
});
</script>
{{ end }}
{{ template "base.html" . }}
