{{ define "content" }}
<h2>Добавление консультации</h2>

<form id="createConsultationForm">
    <label>Дата консультации:</label><br>
    <input type="date" id="dateofconsultation" name="dateofconsultation" required><br><br>

    <label>Время консультации:</label><br>
    <input type="time" id="timeofconsultation" name="timeofconsultation" required><br><br>

    <label>Клиент:</label><br>
    <select id="client" name="client" required>
        <option value="">-- Выберите клиента --</option>
        {{ range .Clients }}
        <option value="{{ .ID }}">{{ .Firstname }} {{ .Lastname }}</option>
        {{ else }}
        <option value="" disabled>Нет доступных клиентов</option>
        {{ end }}
    </select><br><br>

    <label>Примечания:</label><br>
    <input type="text" id="notes" name="notes"><br><br>

    <label>Сотрудник:</label><br>
    <select id="employee" name="employee" required>
        <option value="">-- Выберите сотрудника --</option>
        {{ range .Employees }}
        <option value="{{ .ID }}">{{ .FirstName }} {{ .LastName }}</option>
        {{ else }}
        <option value="" disabled>Нет доступных сотрудников</option>
        {{ end }}
    </select><br><br>

    <input type="submit" value="Сохранить">
</form>

<script>
document.getElementById("createConsultationForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    try {
        const consultation = {
            dateofconsultation: document.getElementById("dateofconsultation").value, // YYYY-MM-DD
            timeofconsultation: document.getElementById("timeofconsultation").value, // HH:MM
            client: document.getElementById("client").value,
            employee: document.getElementById("employee").value,
            notes: document.getElementById("notes").value,
        };

        const res = await fetch("/consultation/new", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
            body: JSON.stringify(consultation)
        });

        if (!res.ok) {
            try {
                const errorData = await res.json();
                throw new Error(errorData.error || errorData.message || `HTTP error! status: ${res.status}`);
            } catch {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
        }

        const data = await res.json();
        alert(data.message || "Консультация успешно создана");
        window.location.href = "/consultation";
    } catch (err) {
        console.error("Ошибка при создании консультации:", err);
        alert("Ошибка: " + err.message);
    }
});
</script>
{{ end }}
{{ template "base.html" . }}
